#include "Talkthrough.h"
#include <stdfix.h>
#define NUM_COEFF 162

//--------------------------------------------------------------------------//
// Function:	Process_Data()												//
//																			//
// Description: This function is called from inside the SPORT0 ISR every 	//
//				time a complete audio frame has been received. The new 		//
//				input samples can be found in the variables iChannel0LeftIn,//
//				iChannel0RightIn, iChannel1LeftIn and iChannel1RightIn 		//
//				respectively. The processed	data should be stored in 		//
//				iChannel0LeftOut, iChannel0RightOut, iChannel1LeftOut,		//
//				iChannel1RightOut, iChannel2LeftOut and	iChannel2RightOut	//
//				respectively.												//
//--------------------------------------------------------------------------//
void Process_Data(void)
{
	/* Old Program, merely passthrough. Holding onto it for debugging purposes.
	iChannel0LeftOut = iChannel0LeftIn;
	iChannel0RightOut = iChannel0RightIn;
	iChannel1LeftOut = iChannel1LeftIn;
	iChannel1RightOut = iChannel1RightIn;
	*/
	
	//I don't know if this will compile but it's technically one line lol
	static const fract filt[NUM_COEFF] = {0.00235455956003r, 0.00220551156530r, 0.00280095641082r, 0.00312185742445r, 0.00304308982707r, 0.00250259141645r, 0.00154822993674r, 0.00032057526390r, -0.00096053984159r, -0.00203387405835r, -0.00266654613723r, -0.00270420457038r, -0.00212937028755r, -0.00106606013151r, 0.00022879346710r, 0.00142940872042r, 0.00221076153526r, 0.00233934605887r, 0.00173604977464r, 0.00051267461054r, -0.00104555253200r, -0.00254161186331r, -0.00356483473056r, -0.00380070104505r, -0.00312186805347r, -0.00163874289972r, 0.00031306655324r, 0.00224343083100r, 0.00362940046085r, 0.00405250903572r, 0.00332186469666r, 0.00154334422047r, -0.00088459223929r, -0.00335557718266r, -0.00520300720528r, -0.00587518697477r, -0.00509450588016r, -0.00295366488212r, 0.00007837133138r, 0.00325372415844r, 0.00572390883855r, 0.00676211494130r, 0.00596876195462r, 0.00340738254642r, -0.00037481545715r, -0.00445400910506r, -0.00774785837969r, -0.00929405686331r, -0.00851991048257r, -0.00543048039086r, -0.00065723215096r, 0.00465608060108r, 0.00911559260442r, 0.01142864405910r, 0.01076070454551r, 0.00700194057542r, 0.00086647212063r, -0.00621821655046r, -0.01242104041674r, -0.01595400317452r, -0.01555243781989r, -0.01086689486446r, -0.00265805060304r, 0.00727608383057r, 0.01644740604028r, 0.02224154609225r, 0.02257822099166r, 0.01651732888375r, 0.00465700768827r, -0.01079044272069r, -0.02629403109346r, -0.03763571359643r, -0.04076339122648r, -0.03269191039328r, -0.01225575975269r, 0.01946020379678r, 0.05912605102477r, 0.10163023630168r, 0.14092768308092r, 0.17111141309793r, 0.18749662633764r, 0.18749662633764r, 0.17111141309793r, 0.14092768308092r, 0.10163023630168r, 0.05912605102477r, 0.01946020379678r, -0.01225575975269r, -0.03269191039328r, -0.04076339122648r, -0.03763571359643r, -0.02629403109346r, -0.01079044272069r, 0.00465700768827r, 0.01651732888375r, 0.02257822099166r, 0.02224154609225r, 0.01644740604028r, 0.00727608383057r, -0.00265805060304r, 
	-0.01086689486446r, -0.01555243781989r, -0.01595400317452r, -0.01242104041674r, -0.00621821655046r, 0.00086647212063r, 0.00700194057542r, 0.01076070454551r, 0.01142864405910r, 0.00911559260442r, 0.00465608060108r, -0.00065723215096r, -0.00543048039086r, -0.00851991048257r, -0.00929405686331r, -0.00774785837969r, -0.00445400910506r, -0.00037481545715r, 0.00340738254642r, 0.00596876195462r, 0.00676211494130r, 0.00572390883855r, 0.00325372415844r, 0.00007837133138r, -0.00295366488212r, -0.00509450588016r, -0.00587518697477r, -0.00520300720528r, -0.00335557718266r, -0.00088459223929r, 0.00154334422047r, 0.00332186469666r, 0.00405250903572r, 0.00362940046085r, 0.00224343083100r, 0.00031306655324r, -0.00163874289972r, -0.00312186805347r, -0.00380070104505r, -0.00356483473056r, -0.00254161186331r, -0.00104555253200r, 0.00051267461054r, 0.00173604977464r, 0.00233934605887r, 0.00221076153526r, 0.00142940872042r, 0.00022879346710r, -0.00106606013151r, -0.00212937028755r, -0.00270420457038r, -0.00266654613723r, -0.00203387405835r, -0.00096053984159r, 0.00032057526390r, 0.00154822993674r, 0.00250259141645r, 0.00304308982707r, 0.00312185742445r, 0.00280095641082r, 0.00220551156530r, 0.00235455956003r};

	static fract delay[NUM_COEFF] = {0.0r};
	accum sum;
	
	delay[0] = rbits((short)(iChannel0LeftIn>>16));
	
	//Apply the filter
	sum = 0.0k;
	int i;
	for(i = 0; i < NUM_COEFF; i++){
		sum += delay[i]*filt[i];
	}
		
	//Shift the delay line
	int j;
	for(j = NUM_COEFF - 1; j > 0; j--){
			delay[j] = delay[j-1];
	}
	
	//Clip the signal
	sum = (sum > ACCUM_MAX) ? ACCUM_MIN : sum;
	sum = (sum < ACCUM_MIN) ? ACCUM_MAX : sum;
			
	iChannel0LeftOut = bitslr((long fract)sum);
	iChannel0RightOut = iChannel0RightIn;
}
